import { Button, HorizontalBox, VerticalBox } from "std-widgets.slint";
import { TitleText, RegularText, MultiChoice, TextButton } from "widgets.slint";
import { CatInfo, MainPlayUpdate, Screen, FullInfo, ChoicePlayUpdate } from "structs.slint";
import { SelectLookUpScreen, LookUpScreen } from "screen-look-up.slint";
import { SelectMainPlayScreen } from "screen-select-main-play.slint";
import { MainPlayScreen } from "screen-main-play.slint";
import { SelectChoicePlayScreen } from "screen-select-choice-play.slint";
import { ChoicePlayScreen } from "screen-choice-play.slint";
import { TextStyle, FontSettings, Palette, Sizes } from "styling.slint";

export component AppWindow inherits Window {
    title: "Geo quiz";
    icon: @image-url("icon.svg");
    // width: 500px;
    // ***************************************************************** //
    //                            PROPERTIES
    // ***************************************************************** //
    in-out property <Screen> screen: Screen.Start;
    // for select look up 
    in property <[string]> search_all_countries : ["Jamaica"]; 
    in property <[bool]> search_countries_mask: [true];
    in property <[string]> all_categories_name: ["Flag", "Outline", "Country", "Capital", "Languages", "Borders", "Region", "Currencies"];
    in property <[string]> txt_categories_name: ["Country", "Capital", "Languages", "Borders", "Region", "Currencies"];
    
    // ***************************************************************** //
    //                            CALLBACKS
    // ***************************************************************** //
    callback look_up_search_changed(search: string);
    callback look_up_selected(num: int);
    callback set_play_config(easy_first:bool, hard_mode:bool, main_play:bool);
    callback close();
    callback reset_score();
    callback save_score();
    callback prep_look_up();
    // main 
    callback next(int);
    callback prev();
    callback start_play([int], int);
    // choice
    callback choice_start_play(int, int);
    callback choice_changed([bool], bool, bool);

    // ***************************************************************** //
    //                            UI LOGIC
    // ***************************************************************** //

    public function back() {
        if root.screen == Screen.MainPlay {
            root.screen = Screen.SelectMainPlay;
        } else if root.screen == Screen.SelectMainPlay {
            root.screen = Screen.Start
        } else if root.screen == Screen.LookUp {
            root.screen = Screen.SelectLookUp;
        } else if root.screen == Screen.SelectLookUp {
            root.screen = Screen.Start;
        } else if root.screen == Screen.ChoicePlay {
            root.screen = Screen.SelectChoicePlay;
        } else if root.screen == Screen.SelectChoicePlay {
            root.screen = Screen.Start
        }
        

    }

    public function update_look_up_selected(infos: FullInfo) {
        w_look_up.infos = infos;
        w_look_up.reset();
        root.focus();
        root.screen = Screen.LookUp
    }

    public function update_screen(info: MainPlayUpdate, cat: [CatInfo]) {
        main_play_s.update_screen(info, cat);
    }

    public function update_choice(info : ChoicePlayUpdate) {
        choice_play_s.update_screen(info);
    }

    forward-focus: my-key-handler;
    my-key-handler := FocusScope {
        key-pressed(event) => {
            if event.text == Key.Escape && !event.repeat {
                root.close();
            } 
            if event.text == Key.Space && !event.repeat {
                main_play_s.info_level += 1;
            }
            if event.text == "b" {
                back();
            }
            if root.screen == Screen.MainPlay {
                if event.text == Key.LeftArrow {
                    root.prev();
                } else if event.text == Key.RightArrow {
                    next(0);
                }
            }
            if root.screen == Screen.ChoicePlay {
                if event.text == Key.LeftArrow {
                    choice_play_s.collect_changed(false, false);
                } else if event.text == Key.RightArrow {
                    choice_play_s.collect_changed(true, false);
                }
            }
            accept
        }
    }
    // ***************************************************************** //
    //                            BACK BUTTON
    // ***************************************************************** //
    TouchArea {
        visible: root.screen != Screen.Start;
        x: Sizes.padding;
        y: Sizes.padding;
        width: Sizes.title_height;
        height: Sizes.title_height;
        Image {
            source: @image-url("back.svg");
            height: Sizes.title_height;
        }

        clicked => {
            back();
        }
    }
    // ***************************************************************** //
    //                            Start Screen
    // ***************************************************************** //
    Rectangle {
        visible: root.screen == Screen.Start;
        VerticalLayout {
            padding: Sizes.padding;
            spacing: Sizes.spacing;
            // padding-left : root.width/10;
            TitleText {
                text: "Geo Quiz";
            }
            Rectangle {}
            Rectangle {
                background: Palette.accent1;
                border-radius: Sizes.std_radius;
                VerticalBox {
                    padding: Sizes.spacing;
                    spacing: Sizes.spacing;
                    w_hard := MultiChoice {
                        choices: ["Independent only", "All territories"];
                    }
                    RegularText {
                        text: w_hard.not_default?  "Show all territories (250 different)" : "Show only independent countries (190 different)" ;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        width: 100%;
                        wrap: word-wrap;
                        style: FontSettings.body-small;
                    }
                }
            }
    
            Rectangle {
                background: Palette.accent1;
                border-radius: Sizes.std_radius;
                VerticalBox {
                    padding: Sizes.spacing;
                    spacing: Sizes.spacing;
                    w_order := MultiChoice {
                        choices: ["Hard first", "Easy first"];
                    }

                    RegularText {
                        text: w_order.not_default?  "Start with better known countries (according to previous scores)" : "Start with lesser known countries (according to previous scores)";
                        horizontal-alignment: center;
                        vertical-alignment: center;
                        width: 100%;
                        wrap: word-wrap;
                        style: FontSettings.body-small;
                    }
                }
            }
            Rectangle {}
            TextButton {
                height: root.height/10;
                width_button: root.width/2;
                text: "Free Play";
                clicked => {
                    root.screen = Screen.SelectMainPlay;
                    set_play_config(w_order.not_default, w_hard.not_default, true);
                
                }
            }
            TextButton{
                width_button: root.width/2;
                height: root.height/10;
                text: "Choices Play";
                clicked => {
                    root.screen = Screen.SelectChoicePlay;
                    set_play_config(w_order.not_default, w_hard.not_default, false);
                }
            }
            TextButton {
                width_button: root.width/2;
                height: root.height/10;
                text: "Look Up Infos";
                clicked => {root.screen = Screen.SelectLookUp}
            }
            TextButton {
                width_button: root.width/2;
                height: root.height/10;
                text: "Reset Score";
                clicked => {reset_score()}
            }
            Rectangle {}
            Rectangle {}
        }
        
    }
    // ***************************************************************** //
    //                            LOOK UP SCREEN
    // ***************************************************************** //
    w_sel_look_up := SelectLookUpScreen {
        visible: root.screen == Screen.SelectLookUp;
        all: root.search_all_countries;
        on: root.search_countries_mask;
        search_changed(search) => {
            look_up_search_changed(search)
        }
        selected(num) => {
            look_up_selected(num) 
        }
    }

    w_look_up := LookUpScreen {
        visible: root.screen == Screen.LookUp;
    }
    
    sel_main_play_s := SelectMainPlayScreen {
        info_type_names: root.all_categories_name;
        guess_type_names: root.txt_categories_name;
        visible: root.screen == Screen.SelectMainPlay;
        play(cat_choices, im_choice, play_mode) => {
            main_play_s.play_mode = 3 -  play_mode;
            start_play(
                cat_choices, 
                im_choice,
            );
            root.screen = Screen.MainPlay;
        }
    }

    main_play_s := MainPlayScreen {
        visible: root.screen == Screen.MainPlay;
        next(score) => {next(score)}
        prev() => {prev()}
    }

    sel_choice_play_s := SelectChoicePlayScreen {
        visible: root.screen == Screen.SelectChoicePlay;
        info_types: root.all_categories_name;
        play(info_type, guess_type) => {
            choice_start_play(
                info_type, 
                guess_type
            );
            root.screen = Screen.ChoicePlay;
        }
        
    }
    choice_play_s := ChoicePlayScreen {
        visible: root.screen == Screen.ChoicePlay;
        changed(was_guessed, next, found) => {choice_changed(was_guessed, next, found)}
    }
}
