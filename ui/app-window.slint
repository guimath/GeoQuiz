import { Button, HorizontalBox } from "std-widgets.slint";
import { TitleText, RegularText, MultiChoice } from "widgets.slint";
import { CatInfo, FullUpdate, Screen, FullInfo } from "structs.slint";
import { SelectLookUpScreen, LookUpScreen } from "screen-look-up.slint";
import { SelectMainPlayScreen } from "screen-select-main-play.slint";
import { MainPlayScreen } from "screen-main-play.slint";

export component AppWindow inherits Window {
    title: "Geo quiz";
    icon: @image-url("icon.svg");
    // width: 500px;
    // ***************************************************************** //
    //                            PROPERTIES
    // ***************************************************************** //
    in-out property <Screen> screen: Screen.Start;
    // for select look up 
    in property <[string]> search_all_countries : ["Jamaica"]; 
    in property <[bool]> search_countries_mask: [true];
    
    // ***************************************************************** //
    //                            CALLBACKS
    // ***************************************************************** //
    callback look_up_search_changed(search: string);
    callback look_up_selected(num: int);
    callback set_play_config(easy_first:bool, hard_mode:bool);
    callback close();
    callback reset_score();
    callback save_score();
    callback prep_look_up();
    callback next(int);
    callback prev();
    callback start_play([int], int);

    // ***************************************************************** //
    //                            UI LOGIC
    // ***************************************************************** //

    public function back() {
        if root.screen == Screen.MainPlay {
            root.screen = Screen.SelectMainPlay;
        } else if root.screen == Screen.SelectMainPlay {
            root.screen = Screen.Start
        } else if root.screen == Screen.LookUp {
            root.screen = Screen.SelectLookUp;
        } else if root.screen == Screen.SelectLookUp {
            root.screen = Screen.Start;
        } else if root.screen == Screen.ChoicePlay {
            root.screen = Screen.SelectChoicePlay;
        } else if root.screen == Screen.SelectChoicePlay {
            root.screen = Screen.Start
        }
        

    }

    public function update_look_up_selected(infos: FullInfo) {
        w_look_up.infos = infos;
        w_look_up.reset();
        root.focus();
        root.screen = Screen.LookUp
    }

    public function update_screen(info: FullUpdate, cat: [CatInfo]) {
        main_play_s.update_screen(info, cat);
    }

    forward-focus: my-key-handler;
    my-key-handler := FocusScope {
        key-pressed(event) => {
            if event.text == Key.Escape && !event.repeat {
                root.close();
            } 
            if event.text == Key.Space && !event.repeat {
                main_play_s.info_level += 1;
            }
            if event.text == "b" {
                back();
            }
            if root.screen == Screen.MainPlay {
                if event.text == Key.LeftArrow {
                    root.prev();
                } else if event.text == Key.RightArrow {
                    next(0);
                }
            }
            accept
        }
    }
    // ***************************************************************** //
    //                            BACK BUTTON
    // ***************************************************************** //
    TouchArea {
        visible: root.screen != Screen.Start;
        x: 10px;
        y: 10px;
        width: 40px;
        height: 40px;
        Image {
            source: @image-url("back.svg");
            height: 40px;
        }

        clicked => {
            back();
        }
    }
    // ***************************************************************** //
    //                            Start Screen
    // ***************************************************************** //
    Rectangle {
        visible: root.screen == Screen.Start;
        VerticalLayout {
            spacing: 10px;
            padding: 20px;
            // padding-left : root.width/10;
            TitleText {
                text: "Geo Quiz";
            }
            Rectangle {}
            Rectangle {
                background: #4a4458ff;
                border-radius: 10px;
                HorizontalBox {
                    padding: 10px;
                    RegularText {
                        text: "Country list includes:";
                        vertical-alignment: center;
                        horizontal-alignment: right;
                        wrap: word-wrap;
                    }
    
                    w_hard := MultiChoice {
                        width: 70%;
                        choices: ["Independent countries only", "All territories"];
                        choices_len: 2;
                        width_per_elem: 40%;
                        spacing: 20pt;
                    }
                }
            }
    
            Rectangle {
                width: 60%;
                background: #4a4458ff;
                border-radius: 10px;
                HorizontalBox {
                    padding: 10px;
                    RegularText {
                        text: "Start with:";
                        horizontal-alignment: right;
                        vertical-alignment: center;
                        wrap: word-wrap;
                    }
    
                    w_order := MultiChoice {
                        width: 70%;
                        choices: ["Lesser known countries", "Better known countries"];
                        choices_len: 2;
                        width_per_elem: 40%;
                        spacing: 20pt;
                    }
                }
            }
            Button{
                height: root.height/6;
                text: "Free Play";
                clicked => {
                    root.screen = Screen.SelectMainPlay;
                    set_play_config(w_order.not_default, w_hard.not_default);
                
                }
            }
            Button{
                height: root.height/6;
                text: "Choices Play";
                clicked => {
                    root.screen = Screen.SelectChoicePlay;
                    set_play_config(w_order.not_default, w_hard.not_default);
                }
            }
            Button {
                height: root.height/6;
                text: "Look Up Infos";
                clicked => {root.screen = Screen.SelectLookUp}
            }
            Button {
                height: root.height/6;
                text: "Reset Score";
                clicked => {reset_score()}
            }
            Rectangle {}
        }
        
    }
    // ***************************************************************** //
    //                            LOOK UP SCREEN
    // ***************************************************************** //
    w_sel_look_up := SelectLookUpScreen {
        visible: root.screen == Screen.SelectLookUp;
        all: root.search_all_countries;
        on: root.search_countries_mask;
        search_changed(search) => {
            look_up_search_changed(search)
        }
        selected(num) => {
            look_up_selected(num) 
        }
    }

    w_look_up := LookUpScreen {
        visible: root.screen == Screen.LookUp;
    }
    
    sel_main_play_s := SelectMainPlayScreen {
        visible: root.screen == Screen.SelectMainPlay;
        play(cat_choices, im_choice) => {
            start_play(
                cat_choices, 
                im_choice
            );
            root.screen = Screen.MainPlay;
        }
    }

    main_play_s := MainPlayScreen {
        visible: root.screen == Screen.MainPlay;
        next(score) => {next(score)}
        prev() => {prev()}
    }
}
